<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Recebimento de Container</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #252526;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 1px solid #3e3e42;
        }

        header {
            background: #007acc;
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #2d2d30;
            border-bottom: 2px solid #007acc;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #2d2d30;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            border-right: 1px solid #3e3e42;
            color: #cccccc;
        }

        .tab:hover {
            background: #3e3e42;
            color: #ffffff;
        }

        .tab.active {
            background: #1e1e1e;
            color: #007acc;
            border-bottom: 3px solid #007acc;
        }

        .tab-content {
            display: none;
            padding: 30px;
            background: #1e1e1e;
            color: #cccccc;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: #252526;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #3e3e42;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #cccccc;
            font-size: 14px;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        select {
            padding: 12px;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: #1e1e1e;
            color: #cccccc;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #007acc;
            background: #252526;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #007acc;
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 122, 204, 0.4);
            background: #005a9e;
        }

        .btn-edit {
            background: #ffa726;
            color: white;
            padding: 6px 12px;
            font-size: 14px;
            margin-right: 5px;
        }

        .btn-delete {
            background: #ef5350;
            color: white;
            padding: 6px 12px;
            font-size: 14px;
        }

        .btn-import {
            background: #26a69a;
            color: white;
            padding: 10px 20px;
            font-size: 14px;
            margin-right: 10px;
        }

        .btn-export {
            background: #42a5f5;
            color: white;
            padding: 10px 20px;
            font-size: 14px;
        }

        .import-section {
            background: #252526;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px dashed #007acc;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .import-info {
            background: #2d2d30;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border-left: 4px solid #007acc;
        }

        .import-info strong {
            display: block;
            margin-bottom: 8px;
            color: #007acc;
        }

        .import-info ul {
            margin-left: 20px;
            color: #cccccc;
        }

        .sub-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #3e3e42;
            padding-bottom: 10px;
        }

        .sub-tab {
            padding: 10px 20px;
            background: #2d2d30;
            border: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            color: #cccccc;
        }

        .sub-tab:hover {
            background: #3e3e42;
            color: #ffffff;
        }

        .sub-tab.active {
            background: #007acc;
            color: white;
        }

        .btn-status {
            background: #4caf50;
            color: white;
            padding: 6px 12px;
            font-size: 14px;
            margin-right: 5px;
        }

        .btn-status.entregue {
            background: #9e9e9e;
            cursor: not-allowed;
        }

        .filter-year {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #252526;
            border-radius: 8px;
            border: 1px solid #3e3e42;
        }

        .filter-year label {
            font-weight: 600;
            color: #cccccc;
        }

        .filter-year select {
            padding: 8px 15px;
            border: 1px solid #007acc;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            color: #007acc;
            background: #1e1e1e;
            cursor: pointer;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 1px solid #3e3e42;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #252526;
            min-width: 1200px;
        }

        thead {
            background: #007acc;
            color: white;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #3e3e42;
            font-size: 13px;
            color: #cccccc;
        }

        tbody tr:hover {
            background: #2d2d30;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-pendente {
            background: #fff3cd;
            color: #856404;
        }

        .status-concluido {
            background: #d4edda;
            color: #155724;
        }

        .status-atrasado {
            background: #f8d7da;
            color: #721c24;
        }

        .search-box {
            margin-bottom: 20px;
            padding: 12px;
            width: 100%;
            max-width: 400px;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            font-size: 14px;
            background: #252526;
            color: #cccccc;
        }

        .search-box:focus {
            outline: none;
            border-color: #007acc;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #007acc;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #005a9e;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #858585;
        }

        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 1.5em;
            }

            .tab {
                font-size: 14px;
                padding: 12px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üì¶ Sistema de Gest√£o de Recebimento de Container</h1>
            <p>Controle completo de importa√ß√µes e recebimentos</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="openTab('registro')">üìù Registro</button>
            <button class="tab" onclick="openTab('consulta')">üìä Consulta</button>
            <button class="tab" onclick="openTab('cadastro')">üöö Cadastro</button>
            <button class="tab" onclick="openTab('dashboard')">üìà Dashboard</button>
        </div>

        <!-- ABA REGISTRO -->
        <div id="registro" class="tab-content active">
            <h2 style="margin-bottom: 20px; color: #007acc;">Novo Registro de Container</h2>
            
            <form id="containerForm" class="form-section">
                <div class="form-row">
                    <div class="form-group">
                        <label for="refTbx">Ref. TBX (Lote do Container) *</label>
                        <input type="text" id="refTbx" required placeholder="Ex: TBX-2025-001">
                    </div>
                    <div class="form-group">
                        <label for="container">N¬∞ Container *</label>
                        <input type="text" id="container" required placeholder="Ex: ABCD1234567">
                    </div>
                    <div class="form-group">
                        <label for="vencimentoPorto">Vencimento Armazenagem PORTO *</label>
                        <input type="date" id="vencimentoPorto" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dataLiberacao">Data da Libera√ß√£o Carregamento</label>
                        <input type="date" id="dataLiberacao">
                    </div>
                    <div class="form-group">
                        <label for="dataCarregamento">Data do Carregamento</label>
                        <input type="date" id="dataCarregamento">
                    </div>
                    <div class="form-group">
                        <label for="vencimentoDemurrage">Vencimento Demurrage *</label>
                        <input type="date" id="vencimentoDemurrage" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="entregaTbx">Entrega TBX (Data)</label>
                        <input type="date" id="entregaTbx">
                    </div>
                    <div class="form-group">
                        <label for="previsaoDescarregamento">Previs√£o de In√≠cio de Descarregamento (Hora)</label>
                        <input type="time" id="previsaoDescarregamento">
                    </div>
                    <div class="form-group">
                        <label for="transportadora">Transportadora</label>
                        <select id="transportadora">
                            <option value="">Selecione uma transportadora</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="frete">Frete (Porto x TBX)</label>
                        <input type="text" id="frete" placeholder="R$ 0,00" oninput="formatarCampoMoeda(this)">
                    </div>
                </div>

                <div style="margin-top: 25px; text-align: right;">
                    <button type="button" class="btn btn-primary" onclick="limparFormulario()" style="background: #999; margin-right: 10px;">Limpar</button>
                    <button type="submit" class="btn btn-primary">üíæ Salvar Registro</button>
                </div>
            </form>
        </div>

        <!-- ABA CONSULTA -->
        <div id="consulta" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #007acc;">Consulta de Registros</h2>
            
            <div class="import-section">
                <h3 style="margin-bottom: 15px; color: #007acc;">üì• Importar/Exportar Dados</h3>
                <div style="margin-bottom: 15px;">
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="importarArquivo(event)" style="display: none;">
                    <button class="btn btn-import" onclick="document.getElementById('fileInput').click()">üìÇ Importar Excel/CSV</button>
                    <button class="btn btn-export" onclick="exportarParaExcel()">üì§ Exportar para Excel</button>
                    <button class="btn btn-delete" onclick="limparTodosDados()" style="margin-left: 10px;">üóëÔ∏è Limpar Todos os Dados</button>
                </div>
                <div class="import-info">
                    <strong>‚ÑπÔ∏è Formato esperado do arquivo:</strong>
                    <ul style="font-size: 13px; margin-top: 5px;">
                        <li>Colunas: Ref. TBX | Containers | Vencimento armazenagem PORTO | Vencimento demurrage | Data da libera√ß√£o carregamento | Data carregamento | Entrada armaz√©m parceiro | Vencimento prazo no armaz√©m | Entrega TBX | Status | Obs | Transporte Porto x TBX | Arm. de container CHEIO | Arm. de container VAZIO | Janela especial | M√£o de obra para descarregamento | Lava√ß√£o container</li>
                        <li>Formato de data: DD/MM/AAAA</li>
                        <li>Suporta arquivos Excel (.xlsx, .xls) e CSV</li>
                    </ul>
                </div>
            </div>

            <div class="sub-tabs">
                <button class="sub-tab active" onclick="filtrarPorStatus('pendente')">Containers Pendentes</button>
                <button class="sub-tab" onclick="filtrarPorStatus('entregue')">Containers Entregues</button>
                <button class="sub-tab" onclick="filtrarPorStatus('todos')">Todos os Containers</button>
                <button class="btn btn-status" onclick="marcarTodosComoEntregue()" style="margin-left: auto;">‚úÖ Marcar Todos como Entregue</button>
            </div>
            
            <input type="text" id="searchInput" class="search-box" placeholder="üîç Buscar por Ref. TBX, Container, Transportadora..." onkeyup="filtrarTabela()">
            
            <div class="table-container">
                <table id="containerTable">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Ref. TBX</th>
                            <th>N¬∞ Container</th>
                            <th>Venc. Porto</th>
                            <th>Data Libera√ß√£o</th>
                            <th>Data Carregamento</th>
                            <th>Venc. Demurrage</th>
                            <th>Entrega TBX</th>
                            <th>Previs√£o Descarga</th>
                            <th>Transportadora</th>
                            <th>Frete (R$)</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="12" class="empty-state">
                                <div>
                                    <div style="font-size: 3em;">üì¶</div>
                                    <p>Nenhum registro encontrado. Adicione um novo registro na aba "Registro".</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ABA CADASTRO -->
        <div id="cadastro" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #007acc;">Cadastro de Transportadoras</h2>
            
            <div class="form-section">
                <h3 style="margin-bottom: 15px; color: #007acc;">üÜï Nova Transportadora</h3>
                <form id="transportadoraForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomeTransportadora">Nome da Transportadora *</label>
                            <input type="text" id="nomeTransportadora" required placeholder="Ex: TURASSI TRANSPORTES">
                        </div>
                    </div>
                    <div style="margin-top: 15px; text-align: right;">
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('transportadoraForm').reset()" style="background: #999; margin-right: 10px;">Limpar</button>
                        <button type="submit" class="btn btn-primary">üíæ Salvar Transportadora</button>
                    </div>
                </form>
            </div>

            <div class="table-container">
                <h3 style="margin-bottom: 15px;">üöö Lista de Transportadoras Cadastradas</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Nome da Transportadora</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="transportadorasTableBody">
                        <tr>
                            <td colspan="2" class="empty-state">
                                <div>
                                    <div style="font-size: 3em;">üöö</div>
                                    <p>Nenhuma transportadora cadastrada. Adicione uma nova acima.</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ABA DASHBOARD -->
        <div id="dashboard" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #007acc;">Dashboard - Vis√£o Geral</h2>
            
            <div class="filter-year" style="margin-bottom: 20px;">
                <label for="filtroAnoDashboard">üìÖ Filtrar por Ano:</label>
                <select id="filtroAnoDashboard" onchange="atualizarDashboard()">
                    <option value="todos">Todos os Anos</option>
                </select>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalContainers">0</h3>
                    <p>Total de Containers</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h3 id="totalFrete">R$ 0,00</h3>
                    <p>Total em Frete</p>
                </div>
            </div>

            <div class="table-container">
                <h3 style="margin-bottom: 15px;">üí∞ Frete por Transportadora</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Transportadora</th>
                            <th>Quantidade de Containers</th>
                            <th>Total em Frete (R$)</th>
                        </tr>
                    </thead>
                    <tbody id="freteTransportadoraBody">
                        <tr>
                            <td colspan="3" class="empty-state">
                                <div>
                                    <div style="font-size: 3em;">üöö</div>
                                    <p>Nenhum dado dispon√≠vel.</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="table-container" style="padding: 20px;">
                <h3 style="margin-bottom: 15px;">üìä An√°lise Mensal de Containers e Frete</h3>
                <canvas id="graficoMensal" style="max-height: 400px;"></canvas>
            </div>

            <div class="table-container">
                <h3 style="margin-bottom: 15px;">üì¶ Containers Recentes (Pendentes)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Ref. TBX</th>
                            <th>N¬∞ Container</th>
                            <th>Transportadora</th>
                            <th>Venc. Demurrage</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="dashboardTableBody">
                        <tr>
                            <td colspan="5" class="empty-state">
                                <div>
                                    <div style="font-size: 3em;">üìä</div>
                                    <p>Nenhum dado dispon√≠vel ainda.</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB-1btOCpD3n9f0cR00iJDN64tGlAbU4wc",
            authDomain: "gestao-containers.firebaseapp.com",
            projectId: "gestao-containers",
            storageBucket: "gestao-containers.firebasestorage.app",
            messagingSenderId: "248431468982",
            appId: "1:248431468982:web:ae62d3255200adb55c6117",
            measurementId: "G-88V7Q1FC8D"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Array para armazenar os registros
        let containers = [];
        let transportadoras = [];
        let editandoId = null;
        let filtroStatusAtual = 'pendente'; // Filtro padr√£o: pendente
        let anoSelecionado = 'todos'; // Ano padr√£o: todos
        let graficoMensal = null; // Vari√°vel para armazenar inst√¢ncia do gr√°fico

        // Carregar dados ao iniciar
        window.onload = function() {
            carregarDadosFirebase();
        };

        // Carregar dados do Firebase
        async function carregarDadosFirebase() {
            try {
                // Carregar containers
                const containersSnapshot = await db.collection('containers').get();
                containers = containersSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Carregar transportadoras
                const transportadorasSnapshot = await db.collection('transportadoras').get();
                transportadoras = transportadorasSnapshot.docs.map(doc => doc.data().nome).sort();

                // Atualizar interface
                atualizarTabela();
                atualizarDashboard();
                carregarTransportadoras();
                atualizarTabelaTransportadoras();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                alert('‚ö†Ô∏è Erro ao carregar dados do servidor. Verifique sua conex√£o.');
            }
        }

        // Salvar container no Firebase
        async function salvarContainerFirebase(registro) {
            try {
                if (editandoId) {
                    // Atualizar
                    await db.collection('containers').doc(editandoId).set(registro);
                } else {
                    // Criar novo
                    const docRef = await db.collection('containers').add(registro);
                    registro.id = docRef.id;
                }
                return true;
            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('‚ö†Ô∏è Erro ao salvar no servidor.');
                return false;
            }
        }

        // Excluir container do Firebase
        async function excluirContainerFirebase(id) {
            try {
                await db.collection('containers').doc(id).delete();
                return true;
            } catch (error) {
                console.error('Erro ao excluir:', error);
                alert('‚ö†Ô∏è Erro ao excluir do servidor.');
                return false;
            }
        }

        // Salvar transportadora no Firebase
        async function salvarTransportadoraFirebase(nome) {
            try {
                await db.collection('transportadoras').add({ nome: nome });
                return true;
            } catch (error) {
                console.error('Erro ao salvar transportadora:', error);
                alert('‚ö†Ô∏è Erro ao salvar transportadora.');
                return false;
            }
        }

        // Excluir transportadora do Firebase
        async function excluirTransportadoraFirebase(nome) {
            try {
                const snapshot = await db.collection('transportadoras').where('nome', '==', nome).get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                return true;
            } catch (error) {
                console.error('Erro ao excluir transportadora:', error);
                alert('‚ö†Ô∏è Erro ao excluir transportadora.');
                return false;
            }
        }

        // Fun√ß√£o para alternar entre abas
        function openTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'dashboard') {
                atualizarDashboard();
            } else if (tabName === 'cadastro') {
                atualizarTabelaTransportadoras();
            }
        }

        // Submeter formul√°rio de transportadora
        document.getElementById('transportadoraForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nome = document.getElementById('nomeTransportadora').value.trim().toUpperCase();
            
            if (transportadoras.includes(nome)) {
                alert('‚ö†Ô∏è Esta transportadora j√° est√° cadastrada!');
                return;
            }
            
            salvarTransportadoraFirebase(nome).then(success => {
                if (success) {
                    transportadoras.push(nome);
                    transportadoras.sort();
                    
                    document.getElementById('transportadoraForm').reset();
                    carregarTransportadoras();
                    atualizarTabelaTransportadoras();
                    
                    alert('‚úÖ Transportadora cadastrada com sucesso!');
                }
            });
        });

        // Carregar transportadoras no select
        function carregarTransportadoras() {
            const select = document.getElementById('transportadora');
            const valorAtual = select.value;
            
            select.innerHTML = '<option value="">Selecione uma transportadora</option>';
            
            transportadoras.forEach(transp => {
                const option = document.createElement('option');
                option.value = transp;
                option.textContent = transp;
                select.appendChild(option);
            });
            
            // Restaurar valor se ainda existir
            if (valorAtual && transportadoras.includes(valorAtual)) {
                select.value = valorAtual;
            }
        }

        // Atualizar tabela de transportadoras
        function atualizarTabelaTransportadoras() {
            const tbody = document.getElementById('transportadorasTableBody');
            
            if (transportadoras.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="2" class="empty-state">
                            <div>
                                <div style="font-size: 3em;">üöö</div>
                                <p>Nenhuma transportadora cadastrada. Adicione uma nova acima.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = transportadoras.map(transp => `
                <tr>
                    <td><strong>${transp}</strong></td>
                    <td>
                        <button class="btn btn-delete" onclick="excluirTransportadora('${transp.replace(/'/g, "\\'")}')">üóëÔ∏è Excluir</button>
                    </td>
                </tr>
            `).join('');
        }

        // Excluir transportadora
        function excluirTransportadora(nome) {
            if (confirm(`Tem certeza que deseja excluir a transportadora "${nome}"?`)) {
                excluirTransportadoraFirebase(nome).then(success => {
                    if (success) {
                        transportadoras = transportadoras.filter(t => t !== nome);
                        carregarTransportadoras();
                        atualizarTabelaTransportadoras();
                        alert('‚úÖ Transportadora exclu√≠da com sucesso!');
                    }
                });
            }
        }

        // Submeter formul√°rio
        document.getElementById('containerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const registro = {
                id: editandoId || Date.now(),
                refTbx: document.getElementById('refTbx').value,
                container: document.getElementById('container').value,
                vencimentoPorto: document.getElementById('vencimentoPorto').value,
                dataLiberacao: document.getElementById('dataLiberacao').value,
                dataCarregamento: document.getElementById('dataCarregamento').value,
                vencimentoDemurrage: document.getElementById('vencimentoDemurrage').value,
                entregaTbx: document.getElementById('entregaTbx').value,
                previsaoDescarregamento: document.getElementById('previsaoDescarregamento').value,
                transportadora: document.getElementById('transportadora').value,
                frete: converterMoedaParaNumero(document.getElementById('frete').value),
                statusEntrega: editandoId ? containers.find(c => c.id === editandoId)?.statusEntrega || 'pendente' : 'pendente'
            };

            // Salvar no Firebase
            salvarContainerFirebase(registro).then(success => {
                if (success) {
                    if (editandoId) {
                        const index = containers.findIndex(c => c.id === editandoId);
                        containers[index] = registro;
                        editandoId = null;
                    } else {
                        containers.push(registro);
                    }
                    
                    limparFormulario();
                    atualizarTabela();
                    atualizarDashboard();
                    
                    alert('‚úÖ Registro salvo com sucesso!');
                    openTab('consulta');
                }
            });
        });

        // Limpar formul√°rio
        function limparFormulario() {
            document.getElementById('containerForm').reset();
            editandoId = null;
        }

        // Atualizar tabela de consulta
        function atualizarTabela() {
            const tbody = document.getElementById('tableBody');
            
            // Filtrar containers baseado no status atual
            let containersFiltrados = containers;
            if (filtroStatusAtual === 'pendente') {
                containersFiltrados = containers.filter(c => c.statusEntrega !== 'entregue');
            } else if (filtroStatusAtual === 'entregue') {
                containersFiltrados = containers.filter(c => c.statusEntrega === 'entregue');
            }
            
            if (containersFiltrados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="empty-state">
                            <div>
                                <div style="font-size: 3em;">üì¶</div>
                                <p>Nenhum registro encontrado nesta categoria.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = containersFiltrados.map(c => {
                const isEntregue = c.statusEntrega === 'entregue';
                return `
                <tr>
                    <td>
                        ${isEntregue 
                            ? '<button class="btn btn-status entregue" disabled>‚úÖ Entregue</button>' 
                            : `<button class="btn btn-status" onclick="marcarComoEntregue(${c.id})">Marcar Entregue</button>`
                        }
                    </td>
                    <td><strong>${c.refTbx}</strong></td>
                    <td>${c.container}</td>
                    <td>${formatarData(c.vencimentoPorto)}</td>
                    <td>${formatarData(c.dataLiberacao)}</td>
                    <td>${formatarData(c.dataCarregamento)}</td>
                    <td>${formatarData(c.vencimentoDemurrage)}</td>
                    <td>${formatarData(c.entregaTbx)}</td>
                    <td>${c.previsaoDescarregamento || '-'}</td>
                    <td>${c.transportadora || '-'}</td>
                    <td>${formatarMoeda(c.frete)}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editarRegistro(${c.id})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-delete" onclick="excluirRegistro(${c.id})">üóëÔ∏è Excluir</button>
                    </td>
                </tr>
            `}).join('');
        }

        // Editar registro
        function editarRegistro(id) {
            const container = containers.find(c => c.id === id);
            if (!container) return;

            document.getElementById('refTbx').value = container.refTbx;
            document.getElementById('container').value = container.container;
            document.getElementById('vencimentoPorto').value = container.vencimentoPorto;
            document.getElementById('dataLiberacao').value = container.dataLiberacao;
            document.getElementById('dataCarregamento').value = container.dataCarregamento;
            document.getElementById('vencimentoDemurrage').value = container.vencimentoDemurrage;
            document.getElementById('entregaTbx').value = container.entregaTbx;
            document.getElementById('previsaoDescarregamento').value = container.previsaoDescarregamento;
            document.getElementById('transportadora').value = container.transportadora;
            document.getElementById('frete').value = container.frete ? formatarMoeda(container.frete) : '';

            editandoId = id;
            openTab('registro');
        }

        // Excluir registro
        function excluirRegistro(id) {
            if (confirm('Tem certeza que deseja excluir este registro?')) {
                excluirContainerFirebase(id).then(success => {
                    if (success) {
                        containers = containers.filter(c => c.id !== id);
                        atualizarTabela();
                        atualizarDashboard();
                        alert('‚úÖ Registro exclu√≠do com sucesso!');
                    }
                });
            }
        }

        // Filtrar tabela
        function filtrarTabela() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const tbody = document.getElementById('tableBody');
            const rows = tbody.getElementsByTagName('tr');

            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(input) ? '' : 'none';
            }
        }

        // Filtrar por status
        function filtrarPorStatus(status) {
            filtroStatusAtual = status;
            
            // Atualizar sub-tabs visuais
            const subTabs = document.querySelectorAll('.sub-tab');
            subTabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            atualizarTabela();
        }

        // Marcar container como entregue
        function marcarComoEntregue(id) {
            if (confirm('Marcar este container como entregue?')) {
                const container = containers.find(c => c.id === id);
                if (container) {
                    container.statusEntrega = 'entregue';
                    
                    salvarContainerFirebase(container).then(success => {
                        if (success) {
                            atualizarTabela();
                            atualizarDashboard();
                            alert('‚úÖ Container marcado como entregue!');
                        }
                    });
                }
            }
        }

        // Marcar todos os containers como entregue
        function marcarTodosComoEntregue() {
            const pendentes = containers.filter(c => c.statusEntrega !== 'entregue');
            
            if (pendentes.length === 0) {
                alert('‚ÑπÔ∏è N√£o h√° containers pendentes para marcar como entregue.');
                return;
            }
            
            if (confirm(`Marcar ${pendentes.length} container(s) pendente(s) como entregue?`)) {
                const promises = containers.map(c => {
                    c.statusEntrega = 'entregue';
                    return salvarContainerFirebase(c);
                });
                
                Promise.all(promises).then(() => {
                    atualizarTabela();
                    atualizarDashboard();
                    alert(`‚úÖ ${pendentes.length} container(s) marcado(s) como entregue!`);
                });
            }
        }


        // Atualizar dashboard
        function atualizarDashboard() {
            // Popular filtros de anos (ambos os selects)
            popularFiltroAnos();

            // Obter ano selecionado do filtro principal do dashboard
            const selectAnoDashboard = document.getElementById('filtroAnoDashboard');
            anoSelecionado = selectAnoDashboard ? selectAnoDashboard.value : 'todos';

            // Filtrar containers por ano
            let containersFiltradosPorAno = containers;
            if (anoSelecionado !== 'todos') {
                containersFiltradosPorAno = containers.filter(c => {
                    const dataRef = c.dataCarregamento || c.vencimentoDemurrage || c.vencimentoPorto;
                    if (dataRef) {
                        const ano = new Date(dataRef).getFullYear();
                        return ano.toString() === anoSelecionado;
                    }
                    return false;
                });
            }

            // Calcular m√©tricas com base nos containers filtrados por ano
            document.getElementById('totalContainers').textContent = containersFiltradosPorAno.length;

            // Calcular total de frete - do ano selecionado
            const totalFrete = containersFiltradosPorAno.reduce((sum, c) => sum + (parseFloat(c.frete) || 0), 0);
            document.getElementById('totalFrete').textContent = formatarMoeda(totalFrete);

            // Atualizar tabela de frete por transportadora - com filtro de ano
            atualizarFreteTransportadora(containersFiltradosPorAno);

            // Atualizar gr√°fico mensal
            atualizarGraficoMensal(containersFiltradosPorAno);

            // Atualizar tabela do dashboard - apenas pendentes do ano selecionado
            const containersPendentesFiltrados = containersFiltradosPorAno.filter(c => c.statusEntrega !== 'entregue');
            const dashboardBody = document.getElementById('dashboardTableBody');
            if (containersPendentesFiltrados.length === 0) {
                dashboardBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div>
                                <div style="font-size: 3em;">üìä</div>
                                <p>Nenhum container pendente no per√≠odo selecionado.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            const containeresRecentes = [...containersPendentesFiltrados].reverse().slice(0, 5);
            dashboardBody.innerHTML = containeresRecentes.map(c => {
                const status = calcularStatus(c.vencimentoDemurrage);
                return `
                    <tr>
                        <td><strong>${c.refTbx}</strong></td>
                        <td>${c.container}</td>
                        <td>${c.transportadora || '-'}</td>
                        <td>${formatarData(c.vencimentoDemurrage)}</td>
                        <td><span class="status-badge ${status.classe}">${status.texto}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Popular filtro de anos
        function popularFiltroAnos() {
            const selectAnoDashboard = document.getElementById('filtroAnoDashboard');
            if (!selectAnoDashboard) return;

            const anoAtual = selectAnoDashboard.value; // Preservar sele√ß√£o atual
            const anos = new Set();

            containers.forEach(c => {
                const dataRef = c.dataCarregamento || c.vencimentoDemurrage || c.vencimentoPorto;
                if (dataRef) {
                    const ano = new Date(dataRef).getFullYear();
                    anos.add(ano);
                }
            });

            const anosOrdenados = Array.from(anos).sort((a, b) => b - a);
            
            let options = '<option value="todos">Todos os Anos</option>';
            anosOrdenados.forEach(ano => {
                options += `<option value="${ano}">${ano}</option>`;
            });

            selectAnoDashboard.innerHTML = options;
            
            // Restaurar sele√ß√£o se ainda existir
            if (anoAtual && (anoAtual === 'todos' || anosOrdenados.includes(parseInt(anoAtual)))) {
                selectAnoDashboard.value = anoAtual;
            }
        }

        // Atualizar tabela de frete por transportadora
        function atualizarFreteTransportadora(todosContainers) {
            const freteBody = document.getElementById('freteTransportadoraBody');
            
            if (todosContainers.length === 0) {
                freteBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="empty-state">
                            <div>
                                <div style="font-size: 3em;">üöö</div>
                                <p>Nenhum container cadastrado no momento.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Agrupar por transportadora
            const transportadoras = {};
            todosContainers.forEach(c => {
                const transp = c.transportadora || 'Sem Transportadora';
                if (!transportadoras[transp]) {
                    transportadoras[transp] = {
                        quantidade: 0,
                        totalFrete: 0
                    };
                }
                transportadoras[transp].quantidade++;
                transportadoras[transp].totalFrete += parseFloat(c.frete) || 0;
            });

            // Ordenar por total de frete (maior para menor)
            const transportadorasOrdenadas = Object.entries(transportadoras)
                .sort((a, b) => b[1].totalFrete - a[1].totalFrete);

            freteBody.innerHTML = transportadorasOrdenadas.map(([nome, dados]) => `
                <tr>
                    <td><strong>${nome}</strong></td>
                    <td>${dados.quantidade}</td>
                    <td><strong style="color: #007acc;">${formatarMoeda(dados.totalFrete)}</strong></td>
                </tr>
            `).join('');
        }

        // Atualizar gr√°fico mensal
        function atualizarGraficoMensal(containersFiltrados) {
            const ctx = document.getElementById('graficoMensal');
            if (!ctx) return;

            // Destruir gr√°fico anterior se existir
            if (graficoMensal) {
                graficoMensal.destroy();
            }

            // Agrupar dados por m√™s
            const dadosPorMes = {};
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            
            // Inicializar todos os meses
            meses.forEach((mes, index) => {
                dadosPorMes[index] = {
                    quantidade: 0,
                    valorTotal: 0
                };
            });

            // Preencher com dados reais
            containersFiltrados.forEach(c => {
                const dataRef = c.dataCarregamento || c.vencimentoDemurrage || c.vencimentoPorto;
                if (dataRef) {
                    const data = new Date(dataRef);
                    const mes = data.getMonth();
                    dadosPorMes[mes].quantidade++;
                    dadosPorMes[mes].valorTotal += parseFloat(c.frete) || 0;
                }
            });

            // Preparar dados para o gr√°fico
            const labels = meses;
            const quantidades = meses.map((_, index) => dadosPorMes[index].quantidade);
            const valores = meses.map((_, index) => dadosPorMes[index].valorTotal);
            
            // Calcular m√©dia de quantidade
            const somaQuantidades = quantidades.reduce((sum, q) => sum + q, 0);
            const mediaQuantidade = containersFiltrados.length > 0 ? somaQuantidades / 12 : 0;
            const linhaMedia = Array(12).fill(mediaQuantidade);

            // Calcular m√©dia de valor
            const somaValores = valores.reduce((sum, v) => sum + v, 0);
            const mediaValor = containersFiltrados.length > 0 ? somaValores / 12 : 0;
            const linhaMediaValor = Array(12).fill(mediaValor);

            // Criar gr√°fico
            graficoMensal = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Quantidade de Containers',
                            data: quantidades,
                            backgroundColor: 'rgba(0, 122, 204, 0.7)',
                            borderColor: '#007acc',
                            borderWidth: 2,
                            yAxisID: 'y',
                            order: 3
                        },
                        {
                            label: 'Valor Total (R$)',
                            data: valores,
                            backgroundColor: 'rgba(79, 172, 254, 0.5)',
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            yAxisID: 'y1',
                            order: 4
                        },
                        {
                            label: 'M√©dia de Quantidade',
                            data: linhaMedia,
                            type: 'line',
                            borderColor: '#f093fb',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            yAxisID: 'y',
                            order: 1
                        },
                        {
                            label: 'M√©dia de Valor',
                            data: linhaMediaValor,
                            type: 'line',
                            borderColor: '#00f2fe',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            pointRadius: 0,
                            yAxisID: 'y1',
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#cccccc',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#252526',
                            titleColor: '#007acc',
                            bodyColor: '#cccccc',
                            borderColor: '#3e3e42',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.yAxisID === 'y1') {
                                        label += formatarMoeda(context.parsed.y);
                                    } else {
                                        label += context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#3e3e42'
                            },
                            ticks: {
                                color: '#cccccc'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Quantidade',
                                color: '#007acc'
                            },
                            grid: {
                                color: '#3e3e42'
                            },
                            ticks: {
                                color: '#cccccc'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Valor (R$)',
                                color: '#4facfe'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                color: '#cccccc',
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                                }
                            }
                        }
                    }
                }
            });
        }

        // Calcular status baseado no vencimento
        function calcularStatus(vencimento) {
            if (!vencimento) return { texto: 'Pendente', classe: 'status-pendente' };
            
            const hoje = new Date();
            const dataVenc = new Date(vencimento);
            const diffDias = Math.floor((dataVenc - hoje) / (1000 * 60 * 60 * 24));

            if (diffDias < 0) {
                return { texto: 'Atrasado', classe: 'status-atrasado' };
            } else if (diffDias <= 7) {
                return { texto: 'Pr√≥ximo', classe: 'status-pendente' };
            } else {
                return { texto: 'No Prazo', classe: 'status-concluido' };
            }
        }

        // Formatar data
        function formatarData(data) {
            if (!data) return '-';
            const d = new Date(data + 'T00:00:00');
            return d.toLocaleDateString('pt-BR');
        }

        // Formatar moeda
        function formatarMoeda(valor) {
            if (!valor) return 'R$ 0,00';
            return 'R$ ' + parseFloat(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Formatar campo de moeda enquanto digita
        function formatarCampoMoeda(input) {
            let value = input.value.replace(/\D/g, '');
            if (value === '') {
                input.value = '';
                return;
            }
            value = (parseInt(value) / 100).toFixed(2);
            input.value = 'R$ ' + parseFloat(value).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Converter moeda formatada para n√∫mero
        function converterMoedaParaNumero(valorFormatado) {
            if (!valorFormatado) return '';
            return valorFormatado.replace('R$', '').replace(/\./g, '').replace(',', '.').trim();
        }

        // Importar arquivo Excel/CSV
        function importarArquivo(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    // Pular a linha de cabe√ßalho
                    const rows = jsonData.slice(1);
                    let importados = 0;
                    const promises = [];

                    rows.forEach(row => {
                        if (!row[0]) return; // Pular linhas vazias

                        const registro = {
                            id: Date.now() + Math.random(),
                            refTbx: row[0] || '',
                            container: row[1] || '',
                            vencimentoPorto: converterDataExcel(row[2]),
                            vencimentoDemurrage: converterDataExcel(row[3]),
                            dataLiberacao: converterDataExcel(row[4]),
                            dataCarregamento: converterDataExcel(row[5]),
                            entregaTbx: converterDataExcel(row[8]),
                            previsaoDescarregamento: extrairHora(row[9]), // Coluna J (Status com texto e hora) - √≠ndice 9
                            transportadora: row[10] || '', // Coluna K (Transportadora) - √≠ndice 10
                            frete: extrairValor(row[11]), // Coluna L (Frete) - √≠ndice 11
                            statusEntrega: 'entregue' // Dados importados s√£o marcados como entregues
                        };

                        containers.push(registro);
                        promises.push(salvarContainerFirebase(registro));
                        importados++;
                    });

                    Promise.all(promises).then(() => {
                        atualizarTabela();
                        atualizarDashboard();
                        
                        alert(`‚úÖ ${importados} registro(s) importado(s) com sucesso!`);
                        event.target.value = ''; // Limpar input
                    });
                } catch (error) {
                    console.error('Erro ao importar:', error);
                    alert('‚ùå Erro ao importar arquivo. Verifique o formato e tente novamente.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Converter data do Excel para formato ISO
        function converterDataExcel(valor) {
            if (!valor) return '';
            
            // Se for n√∫mero (data do Excel)
            if (typeof valor === 'number') {
                const date = XLSX.SSF.parse_date_code(valor);
                return `${date.y}-${String(date.m).padStart(2, '0')}-${String(date.d).padStart(2, '0')}`;
            }
            
            // Se for string no formato DD/MM/YYYY
            if (typeof valor === 'string' && valor.includes('/')) {
                const parts = valor.split('/');
                if (parts.length === 3) {
                    return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                }
            }
            
            return '';
        }

        // Extrair hora do texto
        function extrairHora(texto) {
            if (!texto) return '';
            const match = String(texto).match(/(\d{1,2}):(\d{2})/);
            return match ? `${match[1].padStart(2, '0')}:${match[2]}` : '';
        }

        // Converter hora do Excel (n√∫mero decimal) para HH:MM
        function converterHoraExcel(valor) {
            if (!valor) return '';
            
            // Se for n√∫mero (hora do Excel como fra√ß√£o do dia)
            if (typeof valor === 'number') {
                // Horas no Excel s√£o armazenadas como fra√ß√£o de 24h
                const totalMinutos = Math.round(valor * 24 * 60);
                const horas = Math.floor(totalMinutos / 60);
                const minutos = totalMinutos % 60;
                return `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
            }
            
            // Se for string no formato HH:MM
            if (typeof valor === 'string') {
                const match = valor.match(/(\d{1,2}):(\d{2})/);
                return match ? `${match[1].padStart(2, '0')}:${match[2]}` : '';
            }
            
            return '';
        }

        // Extrair valor num√©rico
        function extrairValor(texto) {
            if (!texto) return '';
            
            // Se for n√∫mero direto do Excel
            if (typeof texto === 'number') {
                return texto.toString();
            }
            
            // Se for string com R$
            if (typeof texto === 'string') {
                const match = texto.match(/R\$\s*([\d.,]+)/);
                if (match) {
                    return match[1].replace(/\./g, '').replace(',', '.');
                }
                // Se for string com n√∫mero
                return texto.replace(/\./g, '').replace(',', '.');
            }
            
            return '';
        }

        // Exportar para Excel
        function exportarParaExcel() {
            if (containers.length === 0) {
                alert('N√£o h√° dados para exportar.');
                return;
            }

            const dados = containers.map(c => ({
                'Ref. TBX': c.refTbx,
                'Containers': c.container,
                'Vencimento armazenagem PORTO': formatarData(c.vencimentoPorto),
                'Vencimento demurrage': formatarData(c.vencimentoDemurrage),
                'Data da libera√ß√£o carregamento': formatarData(c.dataLiberacao),
                'Data carregamento': formatarData(c.dataCarregamento),
                'Entrega TBX': formatarData(c.entregaTbx),
                'Previs√£o in√≠cio descarregamento': c.previsaoDescarregamento || '',
                'Transportadora': c.transportadora || '',
                'Frete (R$)': c.frete || ''
            }));

            const ws = XLSX.utils.json_to_sheet(dados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Containers');
            
            const fileName = `containers_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // Limpar todos os dados
        function limparTodosDados() {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° apagar TODOS os registros salvos. Deseja continuar?')) {
                if (confirm('Tem certeza? Esta a√ß√£o n√£o pode ser desfeita!')) {
                    containers = [];
                    localStorage.setItem('containers', JSON.stringify(containers));
                    atualizarTabela();
                    atualizarDashboard();
                    alert('‚úÖ Todos os dados foram removidos com sucesso!');
                }
            }
        }
    </script>
</body>
</html>